pipeline {
    agent any

    stages {
        stage('Start ZAP Scan') {
            steps {
                echo 'Starting OWASP ZAP security scan...'
                
                sh '''
                mkdir -p reports || true
                chmod 777 reports
                docker run -v $(pwd):/zap/wrk/:rw -t ghcr.io/zaproxy/zaproxy:stable --name owasp-zap zap-baseline.py -t http://www.vulnweb.com -g gen.conf -r zap-report.html || true
                docker exec owasp-zap mkdir -p /zap/wrk
                docker cp owasp-zap:/zap/wrk/zap-report.html ${WORKSPACE}/reports/zap-report.html
                '''
            }
        }
    }

    post {
        always {
            script {
                def reportPath = 'reports/zap-report.html' // Full path to the report
                if (fileExists(reportPath)) {
                    echo 'Publishing ZAP Security Report...'
                    publishHTML (target: [
                        reportFiles: reportPath,  // Directly reference the file
                        reportName: 'OWASP ZAP Security Report',
                        keepAll: true,
                        alwaysLinkToLastBuild: true,
                        allowMissing: false
                    ])
                } else {
                    echo "No ZAP report found. Skipping publishing step."
                }
            }
        }
    }
}